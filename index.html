<!--

This works on chrome ,firefox

some comments wait to add

-->

<!DOCTYPE>
<html>
<head>
    <title>Preview the Upload File before upload</title>
</head>
<body style="text-align: center;">

Please select a picture file and then select an area:
<input id="file" type="file">

<br/>
<br/>

<canvas id="canvas" width="800" height="600" style="border: 1px solid">

</canvas>

</body>
<script>
    window.onload = function(){
        var file = document.getElementById("file");
        file.addEventListener("change", function(event){
            handleFile(event.target.files[0], "canvas");
            return false
        })
    }

    /*
     this function is help to load the file to canvas with the canvas' width and canvas' height
     and the canvas will automatically resize the image to canvas' size in order to make image uploaded looks more friendly
      */
    function handleFile(file, canvasId){

        //file name 'file.name'
        //file mine type 'file.type'
        //file size 'file.size'

        var fileReader = new FileReader();
        fileReader.onload = function (oFREvent) {
            var img = new Image();
            img.onload = function () {
                var canvas = document.getElementById(canvasId);
                var ctx = canvas.getContext('2d');
                var canvasWidth = canvas.width;
                var canvasHeight = canvas.height;
                var imageWidth = img.width;
                var imageHeight = img.height;

                var scaleWidth = imageWidth < imageHeight;
                var scale = 1;
                if (scaleWidth) {
                    scale = canvasWidth / imageWidth;
                } else {
                    scale = canvasHeight / imageHeight;
                }
                var newImageWidth = imageWidth * scale;
                var newImageHeight = imageHeight * scale;
                var x = (canvasWidth - newImageWidth) / 2;
                var y = (canvasHeight - newImageHeight) / 2;

                ctx.drawImage(img, 0, 0, imageWidth, imageHeight, x, y, newImageWidth, newImageHeight);

                var startX;
                var startY;
                var mouseDown = false;
                var mouseStart = false;
                //image result is 'canvas.toDataURL()' with base64 code
                canvas.addEventListener("mousedown", function(event){
                    console.log("Mouse Start at X="+event.offsetX+" Y="+event.offsetY);
                    mouseStart = true;
                    mouseDown = false;
                    startX = event.offsetX - img.offsetLeft;
                    startY = event.offsetY - img.offsetTop;
                }, false);

                canvas.addEventListener("mouseup", function(event){
                    mouseDown = true;
                    mouseStart = false;
                    console.log("Mouse End at X="+event.offsetX+" Y="+event.offsetY);
                    console.log("The Select Area is:",{
                        x: startX,
                        y: startY,
                        x1: event.offsetX - img.offsetLeft - startX,
                        y1: event.offsetY - img.offsetTop - startY
                    });

                    canvas.width = event.offsetX - img.offsetLeft - startX;
                    canvas.height = event.offsetY - img.offsetTop - startY;
                    ctx.drawImage(
                            img, startX, startY, event.offsetX - img.offsetLeft - startX, event.offsetY - img.offsetTop - startY, 0, 0, event.offsetX - img.offsetLeft - startX, event.offsetY - img.offsetTop - startY
                    );
                }, false);

                canvas.addEventListener("mousemove", function(event){
                    if(mouseStart && !mouseDown){
                        ctx.drawImage(img, 0, 0, imageWidth, imageHeight, x, y, newImageWidth, newImageHeight);
                        ctx.fillStyle = 'rgba( 0,0,0,0.8)';
                        var rect = {
                            x: startX,
                            y: startY,
                            x1: event.offsetX - img.offsetLeft - startX,
                            y1: event.offsetY - img.offsetTop - startY
                        };
                        ctx.fillRect( 0, 0, rect.x, newImageHeight );
                        ctx.fillRect( rect.x + rect.x1, 0, newImageWidth - rect.x1, newImageHeight );
                        ctx.fillRect( rect.x, 0, rect.x1, rect.y );
                        ctx.fillRect( rect.x, rect.y+rect.y1, rect.x1, newImageHeight - rect.y1 );
                    }
                }, false);
            }
            img.src = oFREvent.target.result;
        }
        fileReader.readAsDataURL(file);
    }
</script>
</html>
